<!doctype html> 
<meta charset="utf-8"> 
<title>Штука</title>
<style> 
	#output
	{
		color: #ffd40d;
	}
	header {
		background-image: url(images/header.png);
		height: 208px;
		width: 800px;
		border: 4px outset #0b0310;
		margin-left: -4px; 
		margin-top: -3px; }
	body
	{
		background-color: #cbb7d8;
	}

	#stage {
		width: 800px;
		height: 573px;
		border: 4px outset #0b0310;
		background-color: #1f1128;}

	canvas {
		display: block;
		position: absolute;
		margin-left: 580px;
		margin-top: 300px;
		width: 62px;
		height: 62px;
		cursor: pointer;
	}

	#button {
		background-image: url(images/cow.png);
		position: absolute;
		margin-left: -360px;  
		margin-top: 15px;
	}

	</style>

<body>
	<center>
	<div id="stage"><header></header><input type="image" src="images/s.png" id="button" onclick="gameTimer.start()"><p id="output"></p></div>
	<canvas></canvas>

	
	
</center>
</body>

<script> //62
	var star =
	{
		IMAGE: "TileSheet.png",
		SIZE: 64,
		COLUMNS: 3,
		currentFrame: 0, //first
		numberOfFrames: 5, //last  
		sourceX: 0,
		sourceY: 0,
		HIDING: 0,
		JUMPING: 1,
		HIT: 2,
		state: this.HIDING,
		forward: true,
		waitTime: undefined,
		timeToReset: 3,
		resetCounter: 0,

		findWaitTime: function() {
			this.waitTime = Math.ceil(Math.random() * 60); },

		updateAnimation: function() { //!!
			this.sourceX = Math.floor(this.currentFrame % this.COLUMNS) * this.SIZE;
			this.sourceY = Math.floor(this.currentFrame / this.COLUMNS) * this.SIZE;

			if(this.state !== this.HIT)
				if(this.waitTime > 0 || this.waitTime === undefined)
					this.state = this.HIDING;
				else
					this.state = this.JUMPING;

			switch(this.state)
			{
				case this.HIDING:
				this.currentFrame = 0;
				this.waitTime--;
				break;

				case this.JUMPING:
				if(this.currentFrame === this.numberOfFrames)
						this.forward = false;
				if(this.currentFrame === 0 && this.forward === false)
				{
					this.forward = true;
					this.findWaitTime();
					this.state = this.HIDING;
					break;
				}
				if(this.forward)
					this.currentFrame++;
				else
					this.currentFrame--;
				break;

				case this.HIT:
				this.currentFrame = 6;
				this.resetCounter++;
				if(this.resetCounter === this.timeToReset)
					{
						this.resetCounter = 0;
						this.forward = true;
						this.currentFrame = 0;
						this.state = this.HIDING;
						this.findWaitTime();
					}
				break;
			}
		}
	};

	var image = new Image();
	image.addEventListener("load", loadHandler, false);
	image.src = "images/" + star.IMAGE;
	var ROWS = 3;
	var COLUMNS = 3;
	var SIZE = star.SIZE; 
	var SPACE = 8;

	var starObjects = [];
	var starCanvases = [];
	var starDrawingSurfaces = [];

	var starsHit = 0;
	var output = document.querySelector("#output");

	var gameTimer =
	{
		time: 0,
		interval: undefined,
		start: function() {
			var self = this;
			this.interval = setInterval(function(){self.tick();}, 1000); },
		tick: function() {
			this.time--; },
		stop: function() {
			clearInterval(this.interval); },
		reset: function() {
			this.time = 0; }
	};

	function loadHandler()
	{
		buildMap();
		gameTimer.time = 30;
		updateAnimation();
	}

	function buildMap()
	{
		for(var row = 0; row < ROWS; row++)
			{
				for(var column = 0; column < COLUMNS; column++)
				{
					var newstarObject = Object.create(star);
					newstarObject.findWaitTime();
					starObjects.push(newstarObject);
					var canvas = document.createElement("canvas");
					canvas.setAttribute("width", SIZE);
					canvas.setAttribute("height", SIZE);
					stage.appendChild(canvas);
					canvas.style.top = row * (SIZE + SPACE) + "px";
					canvas.style.left = column * (SIZE + SPACE) + "px";
					canvas.addEventListener("mousedown", mousedownHandler, false);
					starCanvases.push(canvas);
					var drawingSurface = canvas.getContext("2d");
					starDrawingSurfaces.push(drawingSurface);
				}
			}
	}

	function updateAnimation()
	{
		if(gameTimer.time > 0)
				setTimeout(updateAnimation, 100); //уровни сложности? 
		for(var i = 0; i < starObjects.length; i++)
					starObjects[i].updateAnimation();
		if(gameTimer.time === 0)
				endGame();
		render();
	}
	function endGame()
	{
		gameTimer.stop();
		for(var i = 0; i < starCanvases.length; i++)
			{
				var canvas = starCanvases[i];
				canvas.removeEventListener("mousedown", mousedownHandler, false);
				//star.state = star.HIDING;
			}

	}

	function mousedownHandler(event)
	{
		var theCanvasThatWasClicked = event.target;
		for(var i = 0; i < starCanvases.length; i++)
				if(starCanvases[i] === theCanvasThatWasClicked)
					{
						var star = starObjects[i]
						if(star.state === star.JUMPING)
							{
								star.state = star.HIT;
								star++;
							}
					}
	}

	function render()
	{
		for(var i = 0; i < starObjects.length; i++)
		{
			var star = starObjects[i];
			var drawingSurface = starDrawingSurfaces[i];
			drawingSurface.clearRect(0, 0, SIZE, SIZE);
			drawingSurface.drawImage(image, star.sourceX, star.sourceY, SIZE, SIZE, 0, 0, SIZE, SIZE);
		}
		output.innerHTML = "Звёзд сбито: " + starsHit + " Время: " + gameTimer.time;
	}
</script>